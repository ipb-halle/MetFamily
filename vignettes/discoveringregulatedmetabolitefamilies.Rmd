---
title: "Discovering regulated Metabolite Families"
author:
- name: Khabat Vahabi
  affiliation: Leibniz Institute of Plant Biochemistry
- name: Steffen Neumann
  affiliation: Leibniz Institute of Plant Biochemistry
  email: sneumann@ipb-halle.de
package: MetFamily
output:
  BiocStyle::html_document:
    toc_float: true
abstract: |
  Description of the MetFamily R package
vignette: |
  %\VignetteIndexEntry{Discovering regulated Metabolite Families with MetFamily}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
csl: biomed-central.csl
---

```{r setup, include=FALSE, echo=FALSE}
library(MetFamily)
```

# Introduction

Some text about the scenario, data and MTBLS297.

Cool paper [@Treutler16DiscoveringRegulatedMetabolite].
 
Cool R package: `r Githubpkg("ipb-halle/MetFamily")`



# Loading the data

First, we load the data and summarise it

```{r load-data}

# Load separate files
filePeakMatrixPath <- system.file("extdata/showcase/Metabolite_profile_showcase.txt", package = "MetFamily")
fileSpectra <- system.file("extdata/showcase/MSMS_library_showcase.msp", package = "MetFamily")
fileAnnotation <- system.file("extdata/testdata/canopus/canopus1680.txt", package = "MetFamily")

parameterSet <- parameterSetDefault()

dataList <- projectFromFiles(filePeakMatrixPath, 
                              fileSpectra,
                              parameterSet = parameterSet,
                              annot_path =fileAnnotation)

```


```{r eval=FALSE, include=FALSE}

# use showcase for testing

# fileName <- system.file("extdata/showcase/Project_file_showcase_annotated.csv.gz", package = "MetFamily")
# project <- readClusterDataFromProjectFile(file = fileName)


```


# Filtering data

We can filter the data to remove low quality data points

```{r filter-data}

filterObj <- make_filterObj(dataList, filter_average = 10000, filter_lfc = 2)

# fileName <- system.file("extdata/testdata/canopus/filterPca_canopus.rds", package = "MetFamily")
# filterObj_file <- readRDS(fileName)
# identical(filterObj_file, filterObj)


```


# PCA

PCA on MS1 in Figure \@ref(fig:pca). 

```{r pca, fig.cap="PCA of MS1.", echo=FALSE}

filterObj <- make_filterObj(dataList, filter_average = 2000, filter_lfc = 1)

pca <- calculatePCA(dataList=dataList,
                         filterObj=filterObj, 
                         ms1AnalysisMethod="PCA (Principal Component Analysis)", 
                         scaling="None", 
                    logTransform=FALSE)

pcaDimensionOne <- 1
pcaDimensionTwo <- 2

# could be easily implemented with ggplot
resultObj <- calcPlotPCAscores(
  pcaObj = pca, 
  dataList = dataList,
  filterObj = filterObj,
  pcaDimensionOne = pcaDimensionOne, 
  pcaDimensionTwo = pcaDimensionTwo, 
  showScoresLabels = FALSE, 
  xInterval = NULL, 
  yInterval = NULL
)

resultObj <- calcPlotPCAloadings(
  pcaObj = pca,
  dataList = dataList,
  # filter = filterObj$filter, # deprecated
  pcaDimensionOne = pcaDimensionOne,
  pcaDimensionTwo = pcaDimensionTwo,
  selectionFragmentPcaLoadingSet = NULL,
  selectionAnalysisPcaLoadingSet = NULL,
  selectionSearchPcaLoadingSet   = NULL,
  xInterval = NULL,
  yInterval = NULL,
  loadingsLabels = "None",
  showLoadingsAbundance = FALSE,
  showLoadingsFeaturesAnnotated   = TRUE,
  showLoadingsFeaturesUnannotated = TRUE,
  showLoadingsFeaturesSelected    = TRUE,
  showLoadingsFeaturesUnselected  = TRUE
)

    
    
```

# HCA

HCA on MS2 in Figure \@ref(fig:hca). 

```{r hca, fig.cap="HCA on MS2.", echo=FALSE, eval=FALSE}

if (FALSE) {
p <- calcPlotDendrogram_plotly(dataList=dataList, #project, 
                               filterObj=filterObj, 
                               clusterDataList=dataList, #project, 
  distanceMeasure = "Jaccard", 
  showClusterLabels=FALSE, 
  hcaPrecursorLabels="m/z / RT", 
  selectionFragmentTreeNodeSet = NULL, 
  selectionAnalysisTreeNodeSet = NULL, 
  selectionSearchTreeNodeSet = NULL, 
  selectedSelection, 
  heatmapContent, 
  heatmapOrdering, 
  heatmapProportion)
}

fileName <- system.file("extdata/testdata/clusterDataList.Rdata", package = "MetFamily")
load(fileName) 
fileName <- system.file("extdata/testdata/hcaFilter.Rdata", package = "MetFamily")
load(fileName) 

returnObj <- calcPlotDendrogram(dataList=dataList, #project, 
                                filter=filter, 
                                clusterDataList=clusterDataList, 
                                annoPresentAnnotationsList = annoPresentAnnotationsList ,
                                annoPresentColorsList = annoPresentColorsList,
                                distanceMeasure="Jaccard (intensity-weighted)", 
                                selectionFragmentTreeNodeSet = NULL, 
                                selectionAnalysisTreeNodeSet = NULL, 
                                selectionSearchTreeNodeSet = NULL, 
                                showClusterLabels = TRUE, 
                                hcaPrecursorLabels = "m/z / RT", 
                                xInterval = c(1,219))

  
```

# References {.unnumbered}

<div id="refs"></div>

# Appendix {.unnumbered}

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

